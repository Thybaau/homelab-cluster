---
# Tasks for gitops_tools role

# ===== kubectl Installation =====

- name: Check if kubectl is already installed
  stat:
    path: "{{ kubectl_install_path }}"
  register: kubectl_exists

- name: Get latest kubectl version
  shell: curl -L -s {{ kubectl_download_url }}/stable.txt
  register: kubectl_version_output
  when: not kubectl_exists.stat.exists
  changed_when: false

- name: Download kubectl binary
  get_url:
    url: "{{ kubectl_download_url }}/{{ kubectl_version_output.stdout }}/bin/linux/amd64/kubectl"
    dest: "{{ kubectl_install_path }}"
    mode: '0755'
  when: not kubectl_exists.stat.exists

- name: Verify kubectl installation
  command: "{{ kubectl_install_path }} version --client"
  register: kubectl_verify
  changed_when: false
  failed_when: kubectl_verify.rc != 0

# ===== kubectl Configuration =====

- name: Create .kube directory for k3s user
  file:
    path: "{{ kubeconfig_user_dir }}"
    state: directory
    owner: k3s
    group: k3s
    mode: '0755'

- name: Configure kubectl on master (symlink to k3s.yaml)
  file:
    src: "{{ k3s_kubeconfig_file }}"
    dest: "{{ kubeconfig_user_file }}"
    state: link
    owner: k3s
    group: k3s
  when: "'k3s_master' in group_names"

- name: Fetch kubeconfig from master
  slurp:
    src: "{{ k3s_kubeconfig_file }}"
  register: master_kubeconfig_raw
  delegate_to: "{{ groups['k3s_master'][0] }}"
  when: "'k3s_workers' in group_names"

- name: Write kubeconfig on worker
  copy:
    content: "{{ master_kubeconfig_raw.content | b64decode }}"
    dest: "{{ kubeconfig_user_file }}"
    owner: k3s
    group: k3s
    mode: '0600'
  when: "'k3s_workers' in group_names"

- name: Set kubeconfig permissions
  file:
    path: "{{ kubeconfig_user_file }}"
    mode: '0600'
    owner: k3s
    group: k3s

# ===== Helm Installation =====

- name: Check if helm is already installed
  stat:
    path: "{{ helm_install_path }}"
  register: helm_exists

- name: Download helm installation script
  get_url:
    url: "{{ helm_install_script_url }}"
    dest: /tmp/get-helm-3.sh
    mode: '0755'
  when: not helm_exists.stat.exists

- name: Install helm
  shell: /tmp/get-helm-3.sh
  environment:
    HELM_INSTALL_DIR: /usr/local/bin
  when: not helm_exists.stat.exists
  changed_when: true

- name: Remove helm installation script
  file:
    path: /tmp/get-helm-3.sh
    state: absent
  when: not helm_exists.stat.exists

- name: Verify helm installation
  command: "{{ helm_install_path }} version"
  register: helm_verify
  changed_when: false
  failed_when: helm_verify.rc != 0

# ===== Helmfile Installation (Master Only) =====

- name: Install Helmfile on master node
  include_tasks: install_helmfile.yml
  when: "'k3s_master' in group_names"
  tags:
    - gitops
    - helmfile

# ===== Helmfile Deployment (Master Only) =====

- name: Deploy infrastructure with Helmfile
  include_tasks: deploy_helmfile.yml
  when: "'k3s_master' in group_names"
  tags:
    - gitops
    - helmfile

# ===== Infrastructure Verification (Master Only) =====

- name: Verify infrastructure deployment
  include_tasks: verify_infrastructure.yml
  when: "'k3s_master' in group_names"
  tags:
    - gitops
    - helmfile
    - verify

# ===== kubectl Verification =====

- name: Test kubectl connectivity to cluster
  command: "{{ kubectl_install_path }} get nodes"
  environment:
    KUBECONFIG: "{{ kubeconfig_user_file }}"
  become: true
  become_user: k3s
  register: kubectl_test
  retries: 5
  delay: 10
  until: kubectl_test.rc == 0
  failed_when: kubectl_test.rc != 0

- name: Display kubectl test result
  debug:
    msg: "kubectl successfully connected to cluster on {{ inventory_hostname }}"
  when: kubectl_test.rc == 0

- name: Display error if kubectl cannot communicate with cluster
  fail:
    msg: "kubectl failed to communicate with cluster on {{ inventory_hostname }}. Error: {{ kubectl_test.stderr }}"
  when: kubectl_test.rc != 0
