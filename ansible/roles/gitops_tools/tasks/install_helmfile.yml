---
# Tasks for installing Helmfile binary on master node

- name: Check if helmfile is already installed
  stat:
    path: "{{ helmfile_install_path }}"
  register: helmfile_exists

- name: Get installed helmfile version
  command: "{{ helmfile_install_path }} version"
  register: helmfile_current_version
  when: helmfile_exists.stat.exists
  changed_when: false
  failed_when: false

- name: Determine if helmfile needs installation
  set_fact:
    helmfile_needs_install: "{{ not helmfile_exists.stat.exists or helmfile_version not in helmfile_current_version.stdout | default('') }}"

- name: Download helmfile binary
  get_url:
    url: "{{ helmfile_download_url }}"
    dest: "/tmp/helmfile_{{ helmfile_version }}"
    checksum: "sha256:{{ helmfile_checksum }}"
    mode: '0755'
  when: helmfile_needs_install
  register: helmfile_download
  retries: 3
  delay: 10
  until: helmfile_download is succeeded

- name: Install helmfile to system path
  copy:
    src: "/tmp/helmfile_{{ helmfile_version }}"
    dest: "{{ helmfile_install_path }}"
    mode: '0755'
    remote_src: true
  when: helmfile_needs_install
  become: true

- name: Remove temporary helmfile download
  file:
    path: "/tmp/helmfile_{{ helmfile_version }}"
    state: absent
  when: helmfile_needs_install

- name: Verify helmfile installation
  command: "{{ helmfile_install_path }} version"
  register: helmfile_verify
  changed_when: false
  failed_when: helmfile_verify.rc != 0

- name: Display helmfile version
  debug:
    msg: "Helmfile install√© : {{ helmfile_verify.stdout }}"
