---
# Tasks for verify_cluster role

- name: Verify kubectl is available
  command: which kubectl
  register: kubectl_check
  failed_when: kubectl_check.rc != 0
  changed_when: false

- name: Wait for all nodes to be Ready
  shell: |
    kubectl get nodes --no-headers | awk '{print $2}' | grep -v Ready
  register: not_ready_nodes
  until: not_ready_nodes.stdout == ""
  retries: "{{ (verification_timeout / retry_delay) | int }}"
  delay: "{{ retry_delay }}"
  failed_when: false
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_file }}"

- name: Get all nodes status
  command: kubectl get nodes --no-headers
  register: nodes_status
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_file }}"

- name: Fail if nodes are not Ready
  fail:
    msg: |
      Some nodes are not in Ready state:
      {{ nodes_status.stdout }}
      
      Nodes not Ready:
      {{ not_ready_nodes.stdout }}
  when: not_ready_nodes.stdout != ""

- name: Get system pods status
  command: kubectl get pods -n kube-system --no-headers
  register: system_pods
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_file }}"

- name: Check for non-Running system pods
  shell: |
    kubectl get pods -n kube-system --no-headers | awk '{print $3}' | grep -v -E '^(Running|Completed)$'
  register: non_running_pods
  failed_when: false
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_file }}"

- name: Fail if system pods are not Running
  fail:
    msg: |
      Some system pods are not in Running state:
      {{ system_pods.stdout }}
  when: non_running_pods.stdout != ""

- name: Count nodes in cluster
  shell: kubectl get nodes --no-headers | wc -l
  register: actual_node_count
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_file }}"

- name: Verify node count matches expected
  fail:
    msg: |
      Node count mismatch!
      Expected: {{ expected_node_count }}
      Actual: {{ actual_node_count.stdout }}
  when: actual_node_count.stdout | int != expected_node_count | int

- name: Get k3s version
  shell: kubectl version --short 2>/dev/null || kubectl version --output=yaml | grep gitVersion | head -1 | awk '{print $2}'
  register: k3s_version
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_file }}"

- name: Get detailed node information
  command: kubectl get nodes -o wide
  register: nodes_detailed
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_file }}"

- name: Generate cluster status report
  set_fact:
    cluster_report: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘              k3s Cluster Status Report                         â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ“Š Cluster Summary:
      -------------------
      Total Nodes:     {{ actual_node_count.stdout }}
      Expected Nodes:  {{ expected_node_count }}
      k3s Version:     {{ k3s_version.stdout | trim }}
      Status:          âœ“ All nodes Ready
      
      ğŸ“‹ Node Details:
      ----------------
      {{ nodes_detailed.stdout }}
      
      ğŸ”§ System Pods:
      ---------------
      {{ system_pods.stdout }}
      
      âœ“ Cluster verification completed successfully!

- name: Display cluster status report
  debug:
    msg: "{{ cluster_report.split('\n') }}"

- name: Save cluster status report to file
  copy:
    content: "{{ cluster_report }}"
    dest: "{{ cluster_report_path }}"
    mode: '0644'
  when: cluster_report_path is defined
